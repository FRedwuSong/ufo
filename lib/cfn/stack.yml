# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-loadbalancer.html
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-targetgroup.html
Description: "Ufo ECS stack <%= @service %>"
Parameters:
  EcsSecurityGroups:
    Description: Existing ecs security group ids
    Type: String
    Default: ''
  ElbSecurityGroups:
    Description: Existing elb security group ids. List with commas.
    Type: String
    Default: ''

  # required
  Subnets:
    Description: Existing subnet ids
    Type: List<AWS::EC2::Subnet::Id>
  Vpc:
    Description: Existing vpc id
    Type: AWS::EC2::VPC::Id

  ElbTargetGroup:
    Description: Existing target group
    Type: String
    Default: '' # when blank the automatically created TargetGroup is used
  CreateElb:
    Description: Create elb
    Type: String
    Default: true
  EcsDesiredCount:
    Description: EcsDesiredCount
    Type: String
    Default: 1
  EcsTaskDefinition:
    Description: EcsTaskDefinition
    Type: String
Conditions:
  CreateElbIsTrue: !Equals [ !Ref CreateElb, true ]
  ElbTargetGroupIsBlank: !Equals [ !Ref ElbTargetGroup, '' ]
  CreateTargetGroupIsTrue: !And
  - !Condition CreateElbIsTrue
  - !Condition ElbTargetGroupIsBlank
  ElbSecurityGroupsIsBlank: !Equals [ !Ref ElbSecurityGroups, '' ]
  EcsSecurityGroupsIsBlank: !Equals [ !Ref EcsSecurityGroups, '' ]
Resources:
  Elb:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Condition: CreateElbIsTrue
    Properties:
      Scheme: internet-facing # or internal
      Subnets: !Ref Subnets
      # LoadBalancerAttributes:
      # - Key: deletion_protection.enabled
      #   Value: "false"
      # - Key: access_logs.s3.enabled
      #   Value: "false"
      # - Key: idle_timeout.timeout_seconds
      #   Value: "1"
      # - Key: access_logs.s3.prefix
      #   Value: "hi-web"
      # - Key: access_logs.s3.bucket
      #   Value: "my-bucket"
      # Add additional extra security groups if param
      SecurityGroups: !Split
        - ','
        - !If
          - ElbSecurityGroupsIsBlank
          - !Ref ElbSecurityGroup
          - !Join [',', [!Ref ElbSecurityGroups, !Ref ElbSecurityGroup]]
      Tags:
      - Key: Name
        Value: <%= @service %>
      - Key: ufo
        Value: <%= @service %>
  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Condition: CreateTargetGroupIsTrue
    DependsOn:
      - Elb
    Properties:
      HealthCheckIntervalSeconds: 60
      UnhealthyThresholdCount: 10
      HealthCheckPath: /
      # Name: "my-elb"
      Port: 80
      Protocol: HTTP
      VpcId: !Ref Vpc
      # TODO: required for fargate or awsvpc network mode
      TargetType: ip
      TargetGroupAttributes:
      - Key: deregistration_delay.timeout_seconds
        Value: 0
  Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: CreateElbIsTrue
    Properties:
      # Certificates:
      #   - Certificate
      DefaultActions:
      - Type: forward
        TargetGroupArn:
          !If [ElbTargetGroupIsBlank, !Ref TargetGroup, !Ref ElbTargetGroup]
      LoadBalancerArn: !Ref Elb
      Port: 80
      Protocol: HTTP

  ElbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: CreateElbIsTrue
    Properties:
      GroupDescription: Allow http to client host
      VpcId: !Ref Vpc
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: '80'
        ToPort: '80'
        CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: '0'
        ToPort: '65535'
        CidrIp: 0.0.0.0/0
      Tags:
      - Key: Name
        Value: <%= @service %>-elb
      - Key: ufo
        Value: <%= @service %>

  # Allow all traffic from ELB SG to ECS SG
  EcsService:
    Type: "AWS::ECS::Service"
    # TODO: see what happens if create a cluster that is already existing
    Properties:
      Cluster: "development"
      DesiredCount: !Ref EcsDesiredCount
      TaskDefinition: !Ref EcsTaskDefinition
#<% unless ENV['RANDOM_NAME'] -%>
#      ServiceName: <%= @service %>
#<% end -%>
      # TODO: required for fargate
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          Subnets: !Ref Subnets # required

          # SecurityGroups: [!Ref EcsSecurityGroup]
          SecurityGroups: !Split
            - ','
            - !If
              - EcsSecurityGroupsIsBlank
              - !Ref EcsSecurityGroup
              - !Join [',', [!Ref EcsSecurityGroups, !Ref EcsSecurityGroup]]

          AssignPublicIp: ENABLED # accepts ENABLED, DISABLED

      # LoadBalancers:
      # - ContainerName: <%= @container_info[:name] %>
      #   ContainerPort: <%= @container_info[:port] %>
      #   TargetGroupArn: !Ref TargetGroup

      LoadBalancers: !If
      - CreateTargetGroupIsTrue
      - - ContainerName: <%= @container_info[:name] %>
          ContainerPort: <%= @container_info[:port] %>
          TargetGroupArn: !Ref TargetGroup
      - !If
        - ElbTargetGroupIsBlank
        - []
        - - ContainerName: <%= @container_info[:name] %>
            ContainerPort: <%= @container_info[:port] %>
            TargetGroupArn: !Ref ElbTargetGroup
  EcsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow http to client host
      VpcId: !Ref Vpc
      # Outbound access: instance needs access to internet to pull down image
      # or else get CannotPullContainerError
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: '0'
        ToPort: '65535'
        CidrIp: 0.0.0.0/0
      Tags:
      - Key: Name
        Value: <%= @service %>-<%= (rand.round(2) * 100).to_i.to_s %>
      - Key: ufo
        Value: <%= @service %>
  EcsCrossSecurityGroupRule:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: CreateElbIsTrue
    Properties:
      IpProtocol: tcp
      FromPort: '0'
      ToPort: '65535'
      SourceSecurityGroupId: !GetAtt ElbSecurityGroup.GroupId
      GroupId: !GetAtt EcsSecurityGroup.GroupId


Outputs:
 Dns:
    Description: Elb Dns
    Condition: CreateElbIsTrue
    Value: !GetAtt Elb.DNSName
